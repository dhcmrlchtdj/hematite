+++
date = '2019-04-25'
title = '前端构建与环境变量'
tags = ['fe']
+++

团队里大部分项目，都以静态 HTML 的方式部署在 S3 上。
有人把这种方式称为 [JAMstack](https://jamstack.org/)。
这种方式相比服务端渲染，最大的优势是运维成本低。
不足之处是不支持首屏渲染，无法满足对 FCP/FMP 要求极高的场景。
即使用 PWA 缓存数据，仍不能满足实时性要求较高的场景。

关于如何生成静态 HTML，我个人倾向以服务端渲染的方式开发，再导出静态页面。
这也是 [next](https://nextjs.org/learn/excel/static-html-export) / [nuxt](https://nuxtjs.org/guide#static-generated-pre-rendering-) / [sapper](https://sapper.svelte.technology/guide#exporting) 都支持的一种方式。
相比直接使用 webpack 等打包工具，开发时有服务端的概念会让编码更灵活，必要时真的切换到服务端渲染的成本也更低。
详细就就不展开了，本文主要想讨论的是测试到上线的流程。

js/node 项目有个约定俗成的环境变量，叫 `NODE_ENV`，用来表示当前属于生产模式（`production`）还是开发模式（`development`）。
见过一些项目使用 `NODE_ENV=test/staging` 之类的值，我只能说，异端。当前处于 production/staging/test 中的哪个流程，应该用其它环境变量来区分。
环境变量在含义应该是正交的，NODE_ENV 在实践用于区分是否为生产模式，进而执行一些生产模式下的优化。
（从这个意义来说，NODE_ENV 和类型系统的目的类似，都是在运行前做足检查，以减少运行时开销。可惜这个检查不像类型系统是有保证的。）
staging/test 等流程，都应该开启 `NODE_ENV=production`，让测试验收与真正发布的内容更一致。

一个很常见的场景，开发测试环境使用测试域名，生产环境使用正式域名。
12factor 推荐用环境变量传递这类外部信息，对于后端服务这也确实是非常好的实践。
但是，前端通常是在构建阶段替换 `NODE_ENV` 等环境变量，修改环境变量就意味着要重新打包。
测试环境和生产环境使用不同的包，显然是不符合预期的结果。

那么，要如何解决重新构建的问题呢？
之前见过一个方案，可惜找不到出处了。
后端服务的动态替换能力来自 `process.env`。
相应的，前端部署时也需要一个类似 `process.env` 的角色。
在 JAMstack 中这可以是 HTML。
JAMstack 的 HTML 可以非常简单，我自己就经常生成一个只有 `<body><div id="app"></div></body>` 的文件作为入口。
要求测试环境、生产环境使用相同的包，是为了保证逻辑一致。只要 HTML 简单到不包含逻辑，就不会对包的稳定性产生影响。
这里对 HTML 的要求其实没这么高，关键是保证变更的内容可理解。
而 JS 的构建经过合并压缩，不同环境变量带来的差异，已经不可能靠肉眼快速识别。
通过注入 `process.env` 生成不同的 HTML，基本能够解决修改环境变量后，需要重新打包的问题。

总结一下
- 使用服务端渲染的方式开发，导出静态页面。
- 保持环境变量的含义单一。
- 动态生成 HTML 以避免多次不同环境重复打包。
