<!--
Title: 这样就满意了吗
Tag: javascript template
-->

# 这样就满意了吗

怎么能把问题推给使用者，我不能接受。

去看了 js 模板的实现，基本上都是 20-30 代码搞定，但我实在不能接受，
算是语言设计上的问题么……

最早看的是 John Resig 的 micro-template，短小精干，只能说佩服的五体投地。
那些 replace、split、join 的用法，到底怎么想出来的。风格就像是 jquery，
一眼看去很乱，但实现上确实非常巧妙。

要说问题的话，就两点：
一是使用 join，现在的测试好像都是说直接字符串相加的效率更高；
二是使用 with，严格模式（strict mode）是不支持 with 的。

第一点好说，稍稍改动即可。第二点就没救了。像性能很高的 doT.js，
开启了严格模式。所以在写模板的时候，变量都要带一个前缀来确定作用域。
在 underscore.js 的实现里，要不就使用 with 语句，要不也一样加个前缀。

像 python 里的 exec 语句是可以确定作用域的。
但 js 的 new Function 还有 eval 语句，至少标准里是不支持改变作用域的。
with 语句又禁用，所以可以说是无解了吧。
让使用者在写模板时特意为每个变量加前缀，根本不符合我的美学。要解决这个问题，
其实就是把添加前缀的任务交给模板函数来实现。
但目前的模板实现似乎都是基于正则替换的，所以很麻烦。
这个应该需要进行词法分析、语法分析吧，等《编译原理》看完再说。

------

看这些模板实现这么些天，最大的收获其实是对 js 的作用域有了更深的了解。
之前妄想能不能靠原型链来解决作用域问题，也去好好看了下 bind、apply、call。
可以的话其他人早就干了……

下一阶段，先把《编译原理》看掉吧。
